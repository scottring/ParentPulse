rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to get user data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Helper function to check if user is a parent
    function isParent() {
      return isSignedIn() && getUserData().role == 'parent';
    }

    // Helper function to check if user belongs to the family
    function belongsToFamily(familyId) {
      return isSignedIn() && getUserData().familyId == familyId;
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own document
      allow read: if isSignedIn() && request.auth.uid == userId;

      // Only the user themselves can create their document (during registration)
      allow create: if isSignedIn() && request.auth.uid == userId;

      // Parents can create child documents in their family
      allow create: if isParent() &&
                       request.resource.data.role == 'child' &&
                       request.resource.data.familyId == getUserData().familyId;

      // Users can update their own document
      allow update: if isSignedIn() && request.auth.uid == userId;

      // Parents can update child documents in their family
      allow update: if isParent() &&
                       resource.data.role == 'child' &&
                       resource.data.familyId == getUserData().familyId;

      // Parents can delete child documents in their family
      allow delete: if isParent() &&
                       resource.data.role == 'child' &&
                       resource.data.familyId == getUserData().familyId;

      // Parents can read all users in their family
      allow read: if isSignedIn() && isParent() &&
                     resource.data.familyId == getUserData().familyId;
    }

    // Families collection
    match /families/{familyId} {
      // Family members can read their family document
      allow read: if belongsToFamily(familyId);

      // Allow authenticated users to create family documents during registration
      // (User document doesn't exist yet, so we can't check isParent())
      allow create: if isSignedIn();

      // Parents in the family can update it
      allow update: if isParent() && belongsToFamily(familyId);
    }

    // Journal entries collection
    match /journal_entries/{entryId} {
      // Parents can read entries in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can create entries in their family
      allow create: if isParent() && belongsToFamily(request.resource.data.familyId);

      // Parents can update their own entries
      allow update: if isParent() &&
                       belongsToFamily(resource.data.familyId) &&
                       resource.data.authorId == request.auth.uid;

      // Parents can delete their own entries
      allow delete: if isParent() &&
                       belongsToFamily(resource.data.familyId) &&
                       resource.data.authorId == request.auth.uid;
    }

    // Child check-ins collection
    match /child_checkins/{checkinId} {
      // Children can create their own check-ins
      allow create: if isSignedIn() &&
                       request.resource.data.childId == request.auth.uid;

      // Children can read their own check-ins
      allow read: if isSignedIn() && resource.data.childId == request.auth.uid;

      // Parents can read check-ins in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);
    }

    // Chip economy collection
    match /chip_economy/{familyId} {
      // Family members can read their chip economy
      allow read: if belongsToFamily(familyId);

      // Allow authenticated users to create chip economy during registration
      allow create: if isSignedIn();

      // Parents can manage chip economy after creation
      allow update, delete: if isParent() && belongsToFamily(familyId);
    }

    // Chip transactions collection
    match /chip_transactions/{transactionId} {
      // Children can read their own transactions
      allow read: if isSignedIn() && resource.data.childId == request.auth.uid;

      // Parents can read transactions in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can create transactions
      allow create: if isParent() && belongsToFamily(request.resource.data.familyId);
    }

    // Knowledge base collection
    match /knowledge_base/{knowledgeId} {
      // Family members can read knowledge in their family
      allow read: if belongsToFamily(resource.data.familyId);

      // Parents can manage knowledge
      allow write: if isParent() && belongsToFamily(resource.data.familyId);
    }

    // AI insights collection
    match /ai_insights/{insightId} {
      // Parents can read insights in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Cloud Functions can create insights (using admin SDK)
      // Parents cannot directly create/edit insights
    }

    // Tasks collection
    match /tasks/{taskId} {
      // Parents can read all tasks in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can create/update/delete tasks
      allow create, update, delete: if isParent() && belongsToFamily(request.resource.data.familyId);
    }

    // Rewards collection
    match /rewards/{rewardId} {
      // Parents can read all rewards in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can create/update/delete rewards
      allow create, update, delete: if isParent() && belongsToFamily(request.resource.data.familyId);
    }

    // Chip transactions collection
    match /chip_transactions/{transactionId} {
      // Parents and children can read transactions in their family
      allow read: if request.auth != null && belongsToFamily(resource.data.familyId);

      // Only parents can create transactions
      allow create: if isParent() && belongsToFamily(request.resource.data.familyId);
    }

    // Knowledge base collection
    match /knowledge_base/{knowledgeId} {
      // Parents can read all knowledge items in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can create knowledge items for their family
      allow create: if isParent() && belongsToFamily(request.resource.data.familyId);

      // Parents can update/delete knowledge items they added
      allow update, delete: if isParent()
        && belongsToFamily(resource.data.familyId)
        && resource.data.addedByParentId == request.auth.uid;
    }

    // Daily actions collection
    match /daily_actions/{actionId} {
      // Parents can read actions in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can update actions (mark complete, skip, add notes)
      allow update: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can manually create actions
      allow create: if isParent() && belongsToFamily(request.resource.data.familyId);

      // Cloud Functions can create actions (using admin SDK)
    }

    // Daily analyses collection
    match /daily_analyses/{analysisId} {
      // Parents can read analyses in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Cloud Functions can create analyses (using admin SDK)
    }

    // Child profiles collection
    match /child_profiles/{profileId} {
      // Parents can read profiles in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can create profiles for children in their family
      allow create: if isParent() && belongsToFamily(request.resource.data.familyId);

      // Parents can update profiles in their family
      allow update: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can delete profiles in their family
      allow delete: if isParent() && belongsToFamily(resource.data.familyId);
    }

    // Strategic plans collection
    match /strategic_plans/{planId} {
      // Parents can read plans in their family
      allow read: if isParent() && belongsToFamily(resource.data.familyId);

      // Parents can update plans (approve, request changes, add notes)
      allow update: if isParent() && belongsToFamily(resource.data.familyId);

      // Cloud Functions create plans (using admin SDK)

      // Plan progress subcollection
      match /plan_progress/{progressId} {
        // Parents can read progress in their family
        allow read: if isParent() && belongsToFamily(resource.data.familyId);

        // Cloud Functions update progress (using admin SDK)
      }
    }
  }
}
